# kintone 福笑いゲームシステム 設計書

## 1. プロジェクト概要
- 20名規模（4チーム対抗）のイベント向けに、kintone上で動作する福笑いゲームを構築する。
- プレイヤーは目隠し状態でPC上の顔パーツを操作し、チームメイトの指示で正しい位置に配置する。
- 自動採点（座標ズレ計算）と審査員加点の合計で順位を決定し、リアルタイムランキングを表示する。

## 2. 技術スタック
- プラットフォーム: kintone（スタンダードコース）
- 言語: JavaScript (ES6+), CSS3
- ライブラリ:
  - Konva.js: Canvas上での画像操作（ドラッグ、キーボード移動）
  - Howler.js: BGMのループ再生と音量調整
  - SweetAlert2: ゲーム開始・終了時のアラート表示
  - kintone UI Component: ボタン・スライダーなどのUIパーツ

## 3. アプリ構成（データベース設計）
### App A: チームマスタ
- チーム名 (team_name): 文字列(1行) / 必須 / 重複禁止
- メンバー名 (member_names): 文字列(複数行)
- チームカラー (team_color): 文字列(1行) / 例: `#FF0000`

### App B: ステージ設定マスタ
- テーマ名 (theme_name): 文字列(1行) / 例: `おかめ` `ひょっとこ` `社長`
- 背景画像 (img_base): 添付ファイル（顔の輪郭のみの画像）
- パーツ画像 (img_parts): 添付ファイル（目・鼻・口など、複数可）
- BGM (bgm_file): 添付ファイル（MP3等）
- 正解座標データ (target_coordinates): 文字列(複数行) / JSONで各パーツの正解配置
- 難易度係数 (difficulty_weight): 数値 / デフォルト: 1

### App C: 福笑いプレイアプリ（メイン）
- チーム選択 (team_lookup): ルックアップ / App A
- テーマ選択 (theme_lookup): ルックアップ / App B（画像・BGMをコピー）
- ステータス (game_status): ラジオボタン / `準備中`, `プレイ中`, `採点完了`
- ゲーム画面エリア (space_game_area): スペースフィールド / JavaScript描画領域
- 自動採点スコア (score_auto): 数値
- 審査員加点 (score_judge): 数値
- 合計スコア (score_total): 計算 / `score_auto + score_judge`
- 完成画像 (result_image): 添付ファイル / Canvasを画像化して保存
- プレイログ (play_log_json): 文字列(複数行) / パーツ配置のJSONログ

## 4. 主要機能（JavaScriptカスタマイズ）
### 4.1 ゲームプレイ画面（詳細画面）
- トリガー: `app.record.detail.show`
- 起動条件: `game_status` が「プレイ中」の場合のみ。
- 画面描画:
  - `space_game_area` に Konva.js で Canvas を生成。
  - 添付ファイルから背景画像を最背面に固定。
  - パーツ画像をランダムまたは画面端に配置し、ドラッグ・キーボード操作を可能にする。
- 操作ロジック:
  - キーボード: 矢印キーでアクティブパーツ移動、Shift併用で移動量増加。
  - マウス: ドラッグ＆ドロップで移動。
- BGM: Howler.js でループ再生。音量スライダーをUIに配置。
- 確定処理: 「配置完了」ボタン押下で BGM 停止、Canvas を画像化して `result_image` にアップロード。パーツ座標をJSON化し `play_log_json` に保存。
- 自動採点: 正解座標とユーザー配置の距離から `score_auto` を算出しレコード更新後にリロード。

### 4.2 自動採点ロジック
- 各パーツについて正解座標 $(x_{target}, y_{target})$ と配置座標 $(x, y)$ のユークリッド距離 $D$ を計算。
- スコア式: `Score = 100 - Σ (D × Weight)`
- スコアがマイナスになった場合は `0` でクリップ。
- Weight は `difficulty_weight` などで調整可能。

### 4.3 リアルタイムランキング（一覧画面）
- トリガー: `app.record.index.show`
- ビュー: カスタムビュー `RankingView` を使用。
- UI: プロジェクター投影用に大きな文字とカード形式。左に順位・チーム名・合計得点、右に完成画像を表示。
- データ処理: REST API でレコードを取得し `score_total` 降順でソート。`setInterval` で10秒毎に自動更新。

## 5. 開発時の注意点
- 画像セキュリティ: kintoneファイルキー利用時はセッション認証を考慮し安全にダウンロードする。
- レスポンシブ: 基本はフルHDを想定しつつ、Canvasサイズは動的取得。
- エラーハンドリング: 画像読み込み失敗などでゲームが止まらないようフォールバックを用意する。

## 6. 今後の実装ステップ例
1. kintone上で App A/B/C を作成し、フィールドコードを上記仕様で設定。
2. App C にカスタマイズビュー・JavaScript/CSS を登録し、Konva.js・Howler.js・SweetAlert2・kintone UI Component を読み込む。
3. 詳細画面のカスタマイズで、ステータス判定→Canvas初期化→画像ロード→操作ロジック→確定処理→採点→レコード更新までを実装。
4. 一覧画面のカスタマイズでランキング表示UIと自動更新ロジックを実装。
5. 画像・音声の取得/保存で認証・容量・失敗時対応を確認し、最終デモを実施。
